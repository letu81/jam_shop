var $btn = $('#order-payment-btn');
<% if @has_shipment %>
  <% if @success %>
    <% if @jsapi_params.blank? %>
      $btn.text('立即支付');
      $btn.data('loading', '0');
      $btn.data('order-no', '<%= @order.order_no %>');
      alert('发起微信支付失败，请重试！');
    <% else %>
      wx.chooseWXPay({
        timestamp: <%= @jsapi_params[:timeStamp] %>,
        nonceStr: '<%= @jsapi_params[:nonceStr] %>',
        package: '<%= @jsapi_params[:package] %>',
        signType: '<%= @jsapi_params[:signType] %>',
        paySign: '<%= @jsapi_params[:paySign] %>',
        success: function (res) {
          window.location.href = '<%= wechat_shop_order_path(@order.order_no) %>';
        },
        cancel: function (res) {
          window.location.href = '<%= wechat_shop_order_path(@order.order_no) %>';
        }
      });
    <% end %>
  <% else %>    
    alert('创建订单失败!');
    window.location.href = '<%= new_wechat_shop_order_path %>';
  <% end %>

<% else %>
  $btn.text('立即支付');
  $btn.data('loading', '0');
  alert('必须选择收货人地址');
<% end %>